<?php declare(strict_types=1);

namespace Reconmap\Repositories;

class VulnerabilityStatsRepository extends MysqlRepository
{
    public function countAll(): int
    {
        $sql = <<<SQL
        SELECT COUNT(*) AS total
        FROM vulnerability
        SQL;

        $stmt = $this->db->prepare($sql);
        $stmt->execute();
        $result = $stmt->get_result();
        $row = $result->fetch_assoc();
        return (int)$row['total'];
    }

    public function findCountByRisk(): array
    {
        $sql = <<<SQL
        SELECT risk, COUNT(*) AS total
        FROM vulnerability
        GROUP BY risk ORDER BY total DESC;
        SQL;

        $result = $this->db->query($sql);
        return $result->fetch_all(MYSQLI_ASSOC);
    }

    public function findCountByCategory(): array
    {
        $sql = <<<SQL
        SELECT vc.name AS category_name, COUNT(*) AS total
        FROM vulnerability v
        INNER JOIN vulnerability_category vc ON (vc.id = v.category_id)
        GROUP BY category_name ORDER BY total DESC;
        SQL;

        $result = $this->db->query($sql);
        return $result->fetch_all(MYSQLI_ASSOC);
    }
}

