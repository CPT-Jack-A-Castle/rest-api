<?php declare(strict_types=1);

namespace Reconmap\Repositories;

use Reconmap\Models\VulnerabilityCategory;

class VulnerabilityCategoryRepository extends MysqlRepository implements Deletable
{
    private const TABLE_NAME = 'vulnerability_category';

    public const UPDATABLE_COLUMNS_TYPES = [
        'parent_id' => 'i',
        'name' => 's',
        'description' => 's'
    ];

    public function findAll(): array
    {
        $sql = <<<SQL
SELECT
       vc.id, vc.name, vc.description,
       vc.parent_id, parent_vc.name AS parent_name
FROM vulnerability_category vc
LEFT JOIN vulnerability_category parent_vc ON (parent_vc.id = vc.parent_id)
ORDER BY PARENT_CHILD_NAME(parent_name, vc.name)
SQL;

        $stmt = $this->db->prepare($sql);
        $stmt->execute();
        $result = $stmt->get_result();
        return $result->fetch_all(MYSQLI_ASSOC);
    }

    public function insert(VulnerabilityCategory $category): int
    {
        $stmt = $this->db->prepare('INSERT INTO vulnerability_category (parent_id, name, description) VALUES (?, ?, ?)');
        $stmt->bind_param('iss', $category->parent_id, $category->name, $category->description);
        return $this->executeInsertStatement($stmt);
    }

    public function updateById(int $id, array $newColumnValues): bool
    {
        return $this->updateByTableId(self::TABLE_NAME, $id, $newColumnValues);
    }

    public function deleteById(int $id): bool
    {
        return $this->deleteByTableId(self::TABLE_NAME, $id);
    }
}
